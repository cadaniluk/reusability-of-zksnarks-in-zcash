% \boldsymbol{n}_1^\text{old},\boldsymbol{n}_2^\text{old}
% a^\text{old}_\text{sk,$1$},a^\text{old}_\text{sk,$2$}


\typeout{IJCAI-11 Instructions for Authors}

% These are the instructions for authors for IJCAI-11.
% They are the same as the ones for IJCAI-07 with superficical wording
%   changes only.

\documentclass{article}
% The file ijcai11.sty is the style file for IJCAI-11 (same as ijcai07.sty).
\usepackage{ijcai11}

% Use the postscript times font!
\usepackage{times}

\usepackage{makecell}
\usepackage{hyperref}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{complexity}
\usepackage{adjustbox}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage[binary-units=true]{siunitx}

% the following package is optional:
%\usepackage{latexsym} 

% Following comment is from ijcai97-submit.tex:
% The preparation of these files was supported by Schlumberger Palo Alto
% Research, AT\&T Bell Laboratories, and Morgan Kaufmann Publishers.
% Shirley Jowell, of Morgan Kaufmann Publishers, and Peter F.
% Patel-Schneider, of AT\&T Bell Laboratories collaborated on their
% preparation.

% These instructions can be modified and used in other conferences as long
% as credit to the authors and supporting agencies is retained, this notice
% is not changed, and further modification or reuse is not restricted.
% Neither Shirley Jowell nor Peter F. Patel-Schneider can be listed as
% contacts for providing assistance without their prior permission.

% To use for other conferences, change references to files and the
% conference appropriate and use other authors, contacts, publishers, and
% organizations.
% Also change the deadline and address for returning papers and the length and
% page charge instructions.
% Put where the files are available in the appropriate places.


\title{The Reusability of zk-SNARKs in the Zcash Protocol}
%\thanks{These match the formatting instructions of IJCAI-07. The support of IJCAI, Inc. is acknowledged.}}
\author{Cordian A. Daniluk \\ 
Laboratoire Jean Kuntzmann\\
Grenoble, France \\
cordian.daniluk@grenoble-inp.org \\
\\
Supervised by: Aude Maignan} % Mosig student

\begin{document}




\maketitle

{% Mosig student
  {\hbox to0pt{\vbox{\baselineskip=10dd\hrule\hbox
to\hsize{\vrule\kern3pt\vbox{\kern3pt
\hbox{{\small I understand what plagiarism entails and I declare that this report }}
\hbox{{\small is my own, original work. }}
\hbox{{\small Cordian A. Daniluk, March 30th, 2022:}}
\kern3pt
}\hfil%\kern3pt
\vrule
}\hrule}
}}
}

\begin{abstract}
        something
\end{abstract}

\section{Introduction}

Cryptocurrencies such as Bitcoin \cite{nakamoto:bitcoin} were designed with the goal to decentralize money transfer.
There should not be a central trusted party such as a bank, through which passes every transaction to remove the need for trust.
However, without any trusted party, transactions are not checked for validity such as the fact that a spender must really be the owner of the spent money and that a spender cannot spend money twice.

A commonly used solution by cryptocurrencies to enforce these rules and yet others is a public ledger called the blockchain \cite{nakamoto:bitcoin}.
The public nature of this data structure enables any node in the cryptocurrency's network to verify rules such as ownership of spent money or double spending money.
However, without appropriate measures a public ledger can lead to compromised privacy by revealing information such as the identities of transaction participants.
In the special case of Bitcoin, a spent amount of money is associated with a destination address, effectively a user's pseudonym.
A user may employ an arbitrary number of pseudonyms to hide their true identity and additionally use methods similar to money laundering, but even these fail to guarantee anonymity \cite{reid:bitcoin-anon}.
Hence, people have tried improving anonymity in new cryptocurrencies such as Monero \cite{saberhagen:cryptonote} or Zcash \cite{hopwood:zcash}.
Zcash is the one this internship is focusing on.

Zcash still uses a blockchain, but to make stronger anonymity guarantees than Bitcoin, Zcash offers shielded transactions as well as transparent transactions inherited from Bitcoin.
While the latter leak data such as the pseudonyms of senders and receivers, the former hide it by either encrypting sensitive information on the blockchain in an anonymity-preserving way or not including it at all.
This lack of inclusion needs additional care, however, since classical Bitcoin nodes need some public information such as a sender's pseudonym to enforce the blockchain's validity.
To this end, a cryptographic construct called zero-knowledge succinct non-interactive argument of knowledge (zk-SNARK) is used.
A zk-SNARK has public and secret inputs.
The former are publicly known, the latter are only known to the sender.
The sender adds all sensitive information as the secret input and some other as the primary input, creates a zk-SNARK from these, and adds it to a shielded transaction.
The zk-SNARK expresses the statement that the sender knows secret inputs such that the transaction is valid, e.g., that the sender rightfully claims ownership of a given amount of money.
Upon inclusion in the blockchain, anyone can verify the zk-SNARK to enforce the transaction's validity.
Hence, nodes do not do this on public data directly included in the blockchain as in Bitcoin, but on a zk-SNARK, which enables validation of transactions without revealing its secret inputs.

The various properties of zk-SNARKs render them useful in Zcash: they are zero-knowledge, meaning that they prove statements given secret inputs without revealing them.
Their succinctness makes for proofs of small size.
Since they are non-interactive, unlike proposed by, for example, the foundational paper of zero-knowledge proofs \cite{goldwasser:zk}, they can be included in the blockchain without further communication between sender and other parties.
Finally, they are arguments, meaning that a malicious, computationally bounded sender cannot fake proofs to mislead nodes in the network.
More specifically, they are arguments of knowledge, which means that not only do secret inputs exist that satisfy the proven statement, but also that the prover knows them.
For a formal definition of zk-SNARKs, see \cite{groth:zksnark}, for example.

Beyond its theoretical definition, zk-SNARKs steadily evolve to make them even more practical.
In Zcash alone, three different zk-SNARKs (\cite{bensasson:zksnark} in the Sprout version, \cite{groth:zksnark} in the Sapling version, \cite{zcash:halo2} in the Orchard version) have been used throughout the protocol's history.
One reason for this evolution is the willingness to reduce time and space requirements of the creation zk-SNARKs.
Creating a transaction type called JoinSplit, which contains a zk-SNARK, takes TODO\SI{1}{\second} and \SI{1}{\gibi\byte} in Sprout and TODO\SI{1}{\second} and \SI{1}{\gibi\byte} in Sapling\footnote{These benchmarks were obtained using hardware described in Section \ref{sec:benchmarks}.}.

There might be situations, where the creation of zk-SNARKs does not have to be done from scratch: the network might have rejected a transaction and the user wants to resend the transaction.
This document will focus on two cases: insufficient transaction fees, which leads to no miner wanting to include the transaction in a block, and chain reorganizations, where blocks become stale because another, longer\footnote{Longer not in terms of block length but accumulated block difficulty.} branch has overtaken them.
It will investigate under what circumstances and to what degree the zk-SNARKs in the resent transaction have to be entirely recalculated, modified, or can be left as is.
The used zk-SNARK is Groth16 \cite{groth:zksnark}, which is used since the Sapling network upgrade.
Additionally, resending will only be considered for transactions sent by a Zcash full node on that same node.
With an efficient resending mechanism, we hope to improve performance of the otherwise costly zk-SNARK creation in Sprout and Sapling.

The report is structured as follows: first, some background information is given on JoinSplit descriptions in Zcash, including the Groth16 zk-SNARK using since Sapling.
Next, the various steps needed to resend a refused transaction are outlined and explained.
The focus here is on the recreation of the zk-SNARK.
Once the theory has been covered, a performance comparison of fully recalculating a zk-SNARK and optimized recalculations in various scenarios are be performed.
The report finishes with a conclusion of the work done and suggestions for future work.

\section{JoinSplit Descriptions} \label{sec:joinsplit}

In general, transactions in Sprout consist of several fields such as version information or a signature, as well as JoinSplit descriptions (in the following also abbreviated as JoinSplit).
Only the latter are relevant to this paper, so we will not detail any further the other parts and only informally explain JoinSplits.
For a full listing and detailed explanation of transaction elements, see \cite{hopwood:zcash}.

JoinSplit descriptions are composed of the elements in Table \ref{fig:joinsplit}, which also contains public inputs to $\pi_\text{ZKJoinSplit}$.
The secret input are listed in Table \ref{fig:secretinputs}.
All data mentioned in this section without explanation can be found in one of these two tables.

A node that sends a JoinSplit creates new shielded notes $\boldsymbol{n}^\text{new}_1,\boldsymbol{n}^\text{new}_2$, which contain elements given in their description in Table \ref{fig:secretinputs}.
The node creates cryptographically hiding and binding commitments of $\boldsymbol{n}^\text{new}_1,\boldsymbol{n}^\text{new}_2$ denoted as $\text{cm}_1^\text{new}, {\text{cm}_2^\text{new}}$ that represent money sent to one Zcash user.
The commitments are stored in the leaves of a binary Merkle tree \cite{merkle:tree}, the \textit{commitment tree}.

If a user wants to spend two commitments, he proves ownership of these by proving knowledge of $a_\text{sk,$1$}^\text{old}, a_\text{sk,$2$}^\text{old}$ and the commitments' existence in the blockchain by proving their membership in the commitment tree at an earlier time.
Furthermore, the user reveals nullifiers $\text{nf}_1^\text{old}, {\text{nf}_2^\text{old}}$ that enable other nodes to check if the same commitments are double-spent and prevent that.
$\boldsymbol{n}^\text{new}_1,\boldsymbol{n}^\text{new}_2$ are shared only with the receiver, so the user encrypts these and puts them as $C_1^\text{enc}, C_2^\text{enc}$ in the JoinSplit.
Finally, measures against malleability are taken and $\pi_\text{ZKJoinSplit}$ is created.

There is a one-to-one correspondence between nullifiers and commitments and shielded notes.
A JoinSplit always has two nullifiers and two new commitments.
To use only one of either, \textit{dummy notes} can be used.

The most prominent element of a JoinSplit is $\pi_\text{ZKJoinSplit}$ that proves a statement about the JoinSplit's validity such that others can verify that the JoinSplit is indeed valid.
$\pi_\text{ZKJoinSplit}$ enforces rules such as

\[v_\text{pub}^\text{old} + v_1^\text{old} + v_2^\text{old} = v_\text{pub}^\text{new} + v_1^\text{new} + v_2^\text{new}\]

or the aforementioned membership of commitments in the commitment tree: for $i \in \{1,2\}$, if $\text{enforceMerklePath}_i = 1$, then $\text{path}_i$ is a valid Merkle path from the commitment corresponding to $\boldsymbol{n}_i^\text{old}$ at index $\text{pos}_i$ to the root $\text{rt}^\text{Sprout}$.
Other rules are enforced, such as whether $a^\text{old}_{\text{sk},i}$ fits $a_{\text{pk},i}$ to prove the spender's possession of the shielded note. However, detailed knowledge of the rules is not relevant for the remainder and can be acquired from \cite{hopwood:zcash}.

$\pi_\text{ZKJoinSplit}$ is created using the Groth16 \cite{groth:zksnark} proving system, so the next section will explain informally how proof creation works.
For a rigorous treatment, see the original paper.

\begin{center}
\begin{table}
{\tiny
\begin{tabular}{ |c|c| } 
        \hline
        \textbf{Name} & \textbf{Description} \\
        \hline
        \rule{0pt}{4ex} {\small ${v_\text{pub}^\text{old}}^\ast$} & \makecell{A value that is drawn from a transparent input and can be used for new commitments\\ in JoinSplits.} \\
        \hline
        \rule{0pt}{4ex} {\small ${v_\text{pub}^\text{new}}^\ast$} & \makecell{A value that is drawn from a shielded note and can be used for\\ a transparent output.} \\
        \hline
        \rule{0pt}{4ex} {\small ${\text{rt}^\text{Sprout}}^\ast$} & \makecell{A root of the commitment tree at some \\ blockheight in the past or a root produced by\\ a previous JoinSplit in the same transaction.} \\
        \hline
        \rule{0pt}{4ex} {\small $\text{nf}_1^\text{old}, {\text{nf}_2^\text{old}}^\ast$} & \makecell{Nullifiers that refer to shielded notes and are made public to prevent\\ double-spending.} \\
        \hline
        \rule{0pt}{4ex} {\small $\text{cm}_1^\text{new}, {\text{cm}_2^\text{new}}^\ast$} & Commitments to new shielded notes. \\
        \hline
        \rule{0pt}{4ex} {\small epk} & A public key relevant to the creation of $C_1^\text{new}, C_2^\text{new}$. \\
        \hline
        \rule{0pt}{4ex} {\small randomSeed} & \makecell{A random value that is used in the creation of $C_1^\text{new}, C_2^\text{new}$ and\\ $h_1, h_2$.} \\
        \hline
        \rule{0pt}{4ex} {\small $h_1, h_2^\ast$} & MAC tags that help enforcing non-malleability of the JoinSplit. \\
        \hline
        \rule{0pt}{4ex} {\small $\pi_\text{ZKJoinSplit}$} & An encoding of the zk-SNARK. \\
        \hline
        \rule{0pt}{4ex} {\small $C_1^\text{enc}, C_2^\text{enc}$} & The new shielded notes in encrypted form destined for the receiver. \\
        \hline
\end{tabular}}
\caption{A JoinSplit description. Public inputs to $\pi_\text{ZKJoinSplit}$ are a subset of these fields and marked with $^\ast$. The fields' names are the same ones as in the original \protect\cite{hopwood:zcash}.} \label{fig:joinsplit}
\end{table}
\end{center}

\begin{center}
\begin{table}
{\tiny
\begin{tabular}{ |c|c| } 
        \hline
        \textbf{Name} & \textbf{Description} \\
        \hline
        \rule{0pt}{4ex} {\small $\varphi$} & \makecell{A randomly sampled value used to verify\\ uniqueness of $\rho_1^\text{new}, \rho_2^\text{new}$.} \\
        \hline
        \rule{0pt}{4ex} {\small $\boldsymbol{n}^\text{old}_1,\boldsymbol{n}^\text{old}_2$} & \makecell{$\forall i \in \{1,2\}\colon \boldsymbol{n}^\text{old}_i = (a_\text{pk,$i$}^\text{old}, v_i^\text{old}, \rho_i^\text{old}, \text{rcm}_i^\text{old})$\\ The content of the shielded notes about to be spent\\ by revealing their associated nullifier. $a_\text{pk,$i$}^\text{old}$ \\ is a public key identifying the owner. $v_i^\text{old}$ is the monetary value\\ contained in the shielded note. $\rho_i^\text{old}$ is a unique identifier\\ to avoid double-spending. $\text{rcm}_i^\text{old}$ is a random\\ commitment trapdoor that is part of the commitment scheme.} \\
        \hline
        \rule{0pt}{4ex} {\small $a_\text{sk,$1$}^\text{old},a_\text{sk,$2$}^\text{old}$} & \makecell{Secret keys that match $a_\text{pk,$1$}^\text{old}, a_\text{pk,$2$}^\text{old}$. Amongst\\ others, used to prove ownership of $\boldsymbol{n}^\text{old}_1,\boldsymbol{n}^\text{old}_2$.} \\
        \hline
        \rule{0pt}{4ex} {\small $\boldsymbol{n}^\text{new}_1,\boldsymbol{n}^\text{new}_2$} & \makecell{$\forall i \in \{1,2\}\colon \boldsymbol{n}^\text{new}_i = (a_\text{pk,$i$}^\text{new}, v_i^\text{new}, \rho_i^\text{new}, \text{rcm}_i^\text{new})$\\ The content of the shielded notes about to be produced. $a_\text{pk,$i$}^\text{new}$ \\ is a public key identifying the receiver. $v_i^\text{new}$ is the monetary value\\ sent to the receiver. $\rho_i^\text{new}$ is a unique identifier\\ to avoid double-spending. $\text{rcm}_i^\text{new}$ is a random\\ commitment trapdoor that is part of the commitment scheme.} \\
        \hline
        \rule{0pt}{4ex} {\small \makecell{$\text{enforceMerklePath}_1$,\\ $\text{enforceMerklePath}_2$}} & \makecell{A bit that indicates if the path in the commitment tree \\ should be verified. Set to $0$ for dummy notes.} \\
        \hline
        \rule{0pt}{4ex} {\small $\text{path}_1,\text{path}_2$} & The path of the respective commitment in the commitment tree. \\
        \hline
        \rule{0pt}{4ex} {\small $\text{pos}_1, \text{pos}_2$} & \makecell{The index of the respective commitment in the leaves of \\ the commitment tree. The leaves are enumerated from \\ left to right starting from $0$. Empty leaves have the value $0$.} \\
        \hline
\end{tabular}}
\caption{The secret inputs to $\pi_\text{ZKJoinSplit}$. The fields' names are the same ones as in the original \protect\cite{hopwood:zcash}.} \label{fig:secretinputs}
\end{table}
\end{center}

\subsection{The Groth16 zk-SNARK}

The Groth16 proving system provides a way to prove statements of the form $x \in L$ for some language $L \in \NP$.
For Zcash, $x$ would be the public parts of a JoinSplit marked with $^\ast$ in Table \ref{fig:joinsplit} and $L$ is the statement ``$x$ is a valid JoinSplit according to the rules mentioned in Section \ref{sec:joinsplit}''.
In this section, we will show informally how a zk-SNARK is produced from such a statement $x \in L$ by reducing $L$ to another problem ARITH-SAT and then encoding ARITH-SAT as a so-called QAP for the creation of $\pi_\text{ZKJoinSplit}$.

$L \in \NP$, so there exists an efficient algorithm $A(x, w)$ such that

\begin{align*} L = \{ x \in \{0,1\}^\ast \colon \exists w \in \{0,1\}^\ast\colon A(x, w) = 0\} \end{align*}

For Zcash, $w$ corresponds to the secret inputs to $\pi_\text{ZKJoinSplit}$ in Table \ref{fig:secretinputs}.
Now, let $\mathbb{F}_q$ be a $q$-order finite field.
For an arithmetic circuit\footnote{For an illustrative image of an arithmetic circuit, see \cite{gennaro:qap} Figure 1.} $C$, let $m + 1$ be the number of wires of $C$, including inputs.
Let $l$ be the number of public inputs and w.l.o.g. assign wires $1$ through $l$ to them.
For practical purposes, wire $0$ is assumed to carry the value $1$.
Now, define ARITH-SAT to be the following language:

\begin{align*}
        \text{ARITH-SAT} := \left\{\begin{aligned}\text{An arithmetic circuit } C \text{ and } x \in \mathbb{F}_q^l \colon \\
        \exists w \in \mathbb{F}_q^{m-l}\colon C(x,w) = 0\end{aligned}\right\}
\end{align*}

$C(x,w)$ represents the output of $C$ if wires are assigned the values in $x$ and $w$.
$x$ is called the ``primary input'', $w$ the ``auxiliary input'' or ``witness'.
ARITH-SAT is \NP-complete (similarly to how 3-SAT is \NP-complete), so $L \leq_p \text{ARITH-SAT}$ and $x \in L$ can be efficiently converted into a form $x_C \in \text{ARITH-SAT}$.

Denote the value of wire $i$, including inputs and wire $0$, by $a_i$.
For $n$ multiplication gates in $C$, choose $r_1, \ldots, r_n$ pairwise distinct in $\mathbb{F}_q$.

Next, define a quadratic arithmetic program (QAP) $Q$ as

\begin{align*}
        Q := \left(\begin{aligned}\{u_i \in \mathbb{F}_q[x] \colon i \in [m]\}, \{v_i \in \mathbb{F}_q[x] \colon i \in [m]\},\\
        \{w_i \in \mathbb{F}_q[x] \colon i \in [m]\}, t \in \mathbb{F}_q[x]\end{aligned}\right)
\end{align*}

Set $t(x) := \prod_{i=1}^n(x-r_i)$.
$Q$ computes an arithmetic circuit $C$ if $x_C = (C,x) \in \text{ARITH-SAT} \iff \text{there exist } a_i$ such that

\begin{align*}
        t(x) \mid \overbrace{\underbrace{\sum_{i=0}^m a_iu_i(x)}_\text{left input} \cdot \underbrace{\sum_{i=0}^m a_iv_i(x)}_\text{right input} - \underbrace{\sum_{i=0}^{m} a_iw_i(x)}_\text{output}}^\text{$P_Q(x)$}
\end{align*}

The idea is that $P_Q(r_i) = 0$ corresponds to the statement ``left input times right input minus output equals zero'' for the $i^\text{th}$ multiplication gate.
Note that the inputs and output are actually not only mere wire values $a_i$, but linear combinations of many wire values.
Practically, this means that every multiplication gate can subsume many addition and scalar multiplication gates (i.e., linear operations).
The coefficients of these linear combinations are hardcoded into $Q$'s polynomials using Lagrange interpolation, for example.

Every multiplication gate is satisfied if and only if $r_1,\ldots,r_n$ are zeros of $P_Q$.
This is given by divisibility by $t$.
For full details on QAPs, see \cite{gennaro:qap}.

Before proving, we need to setup some shared information $\sigma$ between prover and verifier called the \textit{common reference string}.
Let $(G_1, +), (G_2, +)$ be two cyclic $q$-order subgroups of points on certain elliptic curves\footnote{Zcash uses the BLS12-381\cite{barreto:bls} curve, so $G_1,G_2$ are chosen accordingly. For full detail, see \cite{hopwood:zcash}. } with generators $g_1, g_2$, respectively.
Sample randomly $\alpha, \beta, \gamma, \delta, \tau \in \mathbb{F}_q$. Define $\sigma := (\sigma_1, \sigma_2)$ as

\begin{adjustbox}{max width=.5\textwidth}
\parbox{\linewidth}{
\begin{align*}
        \sigma_1 &:= \left\{\begin{aligned}\left(g_1\frac{\beta u_i(\tau) + \alpha v_i(\tau) + w_i(\tau)}{\delta}\right)_{i=l+1}^m =: \boldsymbol\sigma_{1,1},\\
        \left(g_1\frac{\tau^i t(\tau)}{\delta}\right)_{i=0}^{n-2} =: \boldsymbol\sigma_{1,2}, \left(g_1{\tau^i}\right)_{i=0}^{n-1} =: \boldsymbol\sigma_{1,3},\\
        g_1\alpha, g_1\beta, g_1\delta, \left(g_1\frac{\beta u_i(\tau) + \alpha v_i(\tau) + w_i(\tau)}{\gamma}\right)_{i=0}^l\end{aligned}\right\} \\
        \sigma_2 &:= \left\{g_2\beta, g_2\gamma, g_2\delta, (g_2{\tau^i})_{i=0}^{n-1} =: \boldsymbol\sigma_{2,4}\right\}
\end{align*}}
\end{adjustbox}

Given $Q$, the prover now calculates $h \in \mathbb{F}_q[x]$ as

\begin{align}h(x) := \frac{\sum_{i=0}^m a_iu_i(x) \cdot \sum_{i=0}^m a_iv_i(x) - \sum_{i=0}^{m} a_iw_i(x)}{t(x)} \label{eq:h}\end{align}

and obtains the vector of coefficients of $h(x)$ denoted by $\boldsymbol{h}$.
Then, the proof $\pi$ for the statement $x \in L$ is $\pi := (g_1A =: \pi_A, g_2B =: \pi_B, g_1C =: \pi_C)$, where, given randomly sampled $r,s\in \mathbb{F}_q$,

\begin{align}
        A &:= \alpha + \sum_{i=0}^m a_iu_i(\tau) + r\delta \label{eq:A} \\
        B &:= \beta + \sum_{i=0}^m a_iv_i(\tau) + s\delta \label{eq:B} \\
        C &:= \frac{\sum_{i=l+1}^m a_i(\beta u_i(\tau) + \alpha v_i(\tau) + w_i(\tau)) + h(\tau)t(\tau)}{\delta} \label{eq:C} \\
        & + As + Br - rs\delta \nonumber
\end{align}

Given the evaluations of $(g_1{u_i(\tau)})_{i=0}^m$, $(g_1{v_i(\tau)})_{i=0}^m$, and $(g_2{v_i(\tau)})_{i=0}^m$, which can be computed as they are composed of the elements of $\boldsymbol\sigma_{1,3}$ and $\boldsymbol\sigma_{2,4}$, the prover can evaluate the elements using $\sigma$ as follows:

\begin{align}
        g_1A &= g_1\alpha + \sum_{i=0}^m {(g_1{u_i(\tau)})}{a_i} + {(g_1{\delta})}r \label{eq:gA} \\
        g_1B &= g_1\beta + \sum_{i=0}^m {(g_1{v_i(\tau)})}{a_i} + {(g_1{\delta})}s \label{eq:g1B} \\
        g_2B &= g_2\beta + \sum_{i=0}^m {(g_2{v_i(\tau)})}{a_i} + {(g_2{\delta})}s \label{eq:g2B} \\
        g_1C &= \boldsymbol\sigma_{1,1}(a_i)_{i=l+1}^m + \boldsymbol\sigma_{1,2}\boldsymbol{h} + {(g_1A)}s + {(g_1B)}r \nonumber \\
        &+ {(g_1\delta)}{(-rs)} \label{eq:gC} 
\end{align}

Finally, $\pi$ is verified by using a pairing, in Zcash the optimal ate pairing\cite{vercauteren:optimal-ate}, specifically.

\section{Resending Shielded Transactions}

\begin{figure}[t]
\includegraphics[width=8cm]{images/timeline.png}
\caption{Steps involved in resending a transaction.} \label{fig:resend-steps}
\centering
\end{figure}

We assume the series of events in Figure \ref{fig:resend-steps}: a Zcash full node creates and sends a transaction containing a JoinSplit description to its peers.
At some later point, it learns that the transaction has not been included into the blockchain.
The node wants to resend the transaction: it checks what fields need to change, recalculates these and finally resends the transaction.
This process can be repeated until the transaction is in the blockchain.

We assume that the node is capable of sending and resending to an adequate number of peers, such that failure of the physical network never prevents the transaction's inclusion.
Hence, we will not deal with the first and the last step of Figure \ref{fig:resend-steps}.
A node can assume that its transaction has been refused by waiting for the transaction's inclusion and then for its confirmation.
If the node does not find its transaction in its local blockchain after some time, the transaction has been refused.
This can happen for insufficient transaction fees, for example.
If it is included, but not fully confirmed by a sufficient number of blocks, it has been refused as well.
This can happen for a chain reorganization.
Once it is certain that a transaction has been refused, it must be checked what fields of the JoinSplit must change to maximize the chances of inclusion.
All JoinSplit fields, which include public inputs to $\pi_\text{ZKJoinSplit}$, as well as all secret inputs are listed in two tables in Table \ref{fig:joinsplit} and \ref{fig:secretinputs}.

Once it is clear what fields must change, the sender must recalculate them.
By examining the circuit of the JoinSplit statement, we can deduce what other wire assignments change in the circuit.
The circuit is given in Figure \ref{fig:joinsplit-circuit}.
It is mostly composed of instantiations of the SHA-256 compression function, which is used to prove that a commitment belongs to the 29-layer commitment tree.
Hence, if the inputs to that part of the JoinSplit circuit happen to stay the same, then we can possibly gain big performance improvements.

\begin{figure}[t]
\includegraphics[width=8.5cm]{images/joinsplit-groth16-circuit.jpeg}
\caption{The JoinSplit statement implemented in bellman used in Sapling. The blocks corresponding to the SHA-256 compression function are framed. There are $2\cdot 29$ of them: 29 is the depth of the commitment tree and times $2$ because there are two input commitments.} \label{fig:joinsplit-circuit}
\centering
\end{figure}

\section{Optimizing The zk-SNARK's Recalculation}

$I_\text{changed}$ be the set of indices of changed coefficients $a_i$.
Denote the new coefficients by $a'_i$, where $a'_i \neq a_i \iff i \in I_\text{changed}$.
Given $\pi = (\pi_A, \pi_B, \pi_C)$, find new $\pi' = (\pi_A', \pi_B', \pi_C')$.

\begin{algorithm}
\caption{Calculation of Groth16 as implemented in bellman 0.14.0 used by Zcash v5.5.1.}
\begin{algorithmic}
        \Procedure{Prove}{$A$,$B$,$C$}
                \State $h \gets \Call{ComputeQuotient}{A, B, C, t}$
                \State $h_\text{exp} \gets {(g_1^{E_2})}^H$

                \State $l_\text{exp} \gets {(g_1^{E_1})}^{\{a_i \in A \colon i > l\}}$

                \State $a_\text{prim-exp} \gets \prod_{i=0}^l {(g_1^{u_i(\tau)})}^{a_i}$
                \State $a_\text{aux-exp} \gets \prod_{i=l+1}^m {(g_1^{u_i(\tau)})}^{a_i}$

                \State $b_\text{prim1-exp} \gets \prod_{i=0}^l {(g_1^{v_i(\tau)})}^{a_i}$
                \State $b_\text{aux1-exp} \gets \prod_{i=l+1}^m {(g_1^{v_i(\tau)})}^{a_i}$

                \State $b_\text{prim2-exp} \gets \prod_{i=0}^l {(g_2^{v_i(\tau)})}^{a_i}$
                \State $b_\text{aux2-exp} \gets \prod_{i=l+1}^m {(g_2^{v_i(\tau)})}^{a_i}$

                % Evaluate A, B, C
                \State $\pi_A \gets g_1^\alpha \cdot a_\text{prim-exp} \cdot a_\text{aux-exp} \cdot g_1^{r\delta}$
                \State ${\pi_B}_1 \gets g_1^\beta \cdot b_\text{prim1-exp} \cdot b_\text{aux1-exp} \cdot g_1^{s\delta}$
                \State ${\pi_B}_2 \gets g_2^\beta \cdot b_\text{prim2-exp} \cdot b_\text{aux2-exp} \cdot g_2^{s\delta}$
                \State $\pi_C \gets l_\text{exp} \cdot h_\text{exp} \cdot \pi_A^s \cdot {{\pi_B}_1}^r \cdot {g_1}^{-rs\delta}$

                \State \Return $(\pi_A, {\pi_B}_2, \pi_C)$
        \EndProcedure
\end{algorithmic}
\end{algorithm}

Focus on multiexponentiations.

First, try to optimize $\pi_A'$ and implicitly $\pi_B'$ as it is entirely symmetric.
Let $A_\text{old} = \sum_{i\in I_\text{changed}} a_i u_i(\tau)$ and $A_\text{new} = \sum_{i\in I_\text{changed}} a_i' u_i(\tau)$.
Then, we could calculate $\frac{\pi_A\cdot g_1^{A_\text{new}}}{g_1^{A_\text{old}}} = \pi_A'$.
However, since $\pi_A \neq \pi_A'$, we have $\pi_C \neq \pi_C'$, since $\pi_C'$ involves calculating ${g_1^{A'}}^s$. For that we need knowledge of $s$.
Similarly for $r$.
Sampling new $r$ and $s$ prevents replacing coefficients in $\pi_A'$.
Hence, without knowledge of $r$ and $s$, we cannot apply this method.

Now, consider $\pi_C'$.
Given knowledge of $r$ and $s$, $b_\text{prim1-exp}$ and $b_\text{aux1-exp}$ could be optimized like $\pi_A'$ and $\pi_B'$.


\section{Performance Measurements} \label{sec:benchmarks}

\begin{center}
\begin{tabular}{ c c }
        $h_\text{exp} $ & \SI{33}{\second} \\
        $l_\text{exp}$ & \SI{2}{\second} \\
        $a_\text{prim-exp}$ & \SI{1}{\milli\second} \\
        $a_\text{aux-exp}$ & \SI{2}{\second} \\
        $b_\text{prim1-exp}$ & \SI{1}{\milli\second} \\
        $b_\text{aux1-exp}$ & \SI{1.4}{\second} \\
        $b_\text{prim2-exp}$ & \SI{1}{\milli\second} \\
        $b_\text{aux2-exp}$ & \SI{4.3}{\second}
\end{tabular}
\end{center}

%        g_1^A &= g_1^\alpha \prod_{i=0}^m {(g_1^{u_i(\tau)})}^{a_i} g_1^{r\delta} \label{eq:gA} \\
%        g_1^B &= g_1^\beta \prod_{i=0}^m {(g_1^{v_i(\tau)})}^{a_i} g_1^{s\delta} \label{eq:g1B} \\
%        g_2^B &= g_2^\beta \prod_{i=0}^m {(g_2^{v_i(\tau)})}^{a_i} g_2^{s\delta} \label{eq:g2B} \\
%        g_1^C &= {(g_1^{E_1})}^{\{a_i \in A \colon i > l\}} {(g_1^{E_2})}^H {(g_1^A)}^s {(g_1^B)}^r {g_1}^{-rs\delta} \label{eq:gC} 

\section{Conclusion}

\section{Outlook}

%\subsection{Length of Papers}
%
%Each accepted full paper is allocated six pages in the conference 
%proceedings. Up to two additional pages may be purchased at a price 
%of \$275 per page for any accepted paper. However, all 
%{\em submissions} must 
%be a maximum of six pages in length.
%
%
%\subsection{Word Processing Software}
%
%As detailed below, IJCAI has prepared and made available a set of
%\LaTeX{} macros and a Microsoft Word template for use in formatting
%your paper. If you are using some other word processing software (such
%as WordPerfect, etc.), please follow the format instructions given
%below and ensure that your final paper looks as much like this sample
%as possible.
%
%\section{Style and Format}
%
%\LaTeX{} and Word style files that implement these instructions
%can be retrieved electronically. (See Appendix~\ref{stylefiles} for
%instructions on how to obtain these files.)
%
%\subsection{Layout}
%
%Print manuscripts two columns to a page, in the manner in which these
%instructions are printed. The exact dimensions for pages are:
%\begin{itemize}
%\item left and right margins: .75$''$
%\item column width: 3.375$''$
%\item gap between columns: .25$''$
%\item top margin---first page: 1.375$''$
%\item top margin---other pages: .75$''$
%\item bottom margin: 1.25$''$
%\item column height---first page: 6.625$''$
%\item column height---other pages: 9$''$
%\end{itemize}
%
%All measurements assume an 8-1/2$''$ $\times$ 11$''$ page size. For
%A4-size paper, use the given top and left margins, column width,
%height, and gap, and modify the bottom and right margins as necessary.
%
%\subsection{Format of Electronic Manuscript}
%
%For the production of the electronic manuscript, you must use Adobe's
%{\em Portable Document Format} (PDF). A PDF file can be generated, for
%instance, on Unix systems using {\tt ps2pdf} or on Windows systems
%using Adobe's Distiller. There is also a website with free software
%and conversion services: {\tt http://www.ps2pdf.com/}. For reasons of
%uniformity, use of Adobe's {\em Times Roman} font is strongly suggested. In
%\LaTeX2e{}, this is accomplished by putting
%\begin{quote} 
%\mbox{\tt $\backslash$usepackage\{times\}}
%\end{quote}
%in the preamble.\footnote{You may want also to use the package {\tt
%latexsym}, which defines all symbols known from the old \LaTeX{}
%version.}
%  
%Additionally, it is of utmost importance to specify the American {\bf
%letter} format (corresponding to 8-1/2$''$ $\times$ 11$''$) when
%formatting the paper. When working with {\tt dvips}, for instance, one
%should specify {\tt -t letter}.
%
%\subsection{Title and Author Information}
%
%Center the title on the entire width of the page in a 14-point bold
%font. Below it, center the author name(s) in a 12-point bold font, and
%then center the address(es) in a 12-point regular font. Credit to a
%sponsoring agency can appear on the first page as a footnote.
%
%\subsubsection{Blind Review}
%
%In order to make blind reviewing possible, authors must omit their
%names and affiliations when submitting the paper for review. In place
%of names and affiliations, provide a list of content areas. When
%referring to one's own work, use the third person rather than the
%first person. For example, say, ``Previously,
%Gottlob~\shortcite{gottlob:nonmon} has shown that\ldots'', rather
%than, ``In our previous work~\cite{gottlob:nonmon}, we have shown
%that\ldots'' Try to avoid including any information in the body of the
%paper or references that would identify the authors or their
%institutions. Such information can be added to the final camera-ready
%version for publication.
%
%\subsection{Abstract}
%
%Place the abstract at the beginning of the first column 3$''$ from the
%top of the page, unless that does not leave enough room for the title
%and author information. Use a slightly smaller width than in the body
%of the paper. Head the abstract with ``Abstract'' centered above the
%body of the abstract in a 12-point bold font. The body of the abstract
%should be in the same font as the body of the paper.
%
%The abstract should be a concise, one-paragraph summary describing the
%general thesis and conclusion of your paper. A reader should be able
%to learn the purpose of the paper and the reason for its importance
%from the abstract. The abstract should be no more than 200 words long.
%
%\subsection{Text}
%
%The main body of the text immediately follows the abstract. Use
%10-point type in a clear, readable font with 1-point leading (10 on
%11).
%
%Indent when starting a new paragraph, except after major headings.
%
%\subsection{Headings and Sections}
%
%When necessary, headings should be used to separate major sections of
%your paper. (These instructions use many headings to demonstrate their
%appearance; your paper should have fewer headings.)
%
%\subsubsection{Section Headings}
%
%Print section headings in 12-point bold type in the style shown in
%these instructions. Leave a blank space of approximately 10 points
%above and 4 points below section headings.  Number sections with
%arabic numerals.
%
%\subsubsection{Subsection Headings}
%
%Print subsection headings in 11-point bold type. Leave a blank space
%of approximately 8 points above and 3 points below subsection
%headings. Number subsections with the section number and the
%subsection number (in arabic numerals) separated by a
%period.
%
%\subsubsection{Subsubsection Headings}
%
%Print subsubsection headings in 10-point bold type. Leave a blank
%space of approximately 6 points above subsubsection headings. Do not
%number subsubsections.
%
%\subsubsection{Special Sections}
%
%You may include an unnumbered acknowledgments section, including
%acknowledgments of help from colleagues, financial support, and
%permission to publish.
%
%Any appendices directly follow the text and look like sections, except
%that they are numbered with capital letters instead of arabic
%numerals.
%
%The references section is headed ``References,'' printed in the same
%style as a section heading but without a number. A sample list of
%references is given at the end of these instructions. Use a consistent
%format for references, such as that provided by Bib\TeX{}. The reference
%list should not include unpublished work.
%
%\subsection{Citations}
%
%Citations within the text should include the author's last name and
%the year of publication, for example~\cite{gottlob:nonmon}.  Append
%lowercase letters to the year in cases of ambiguity.  Treat multiple
%authors as in the following examples:~\cite{abelson-et-al:scheme}
%or~\cite{bgf:Lixto} (for more than two authors) and
%\cite{brachman-schmolze:kl-one} (for two authors).  If the author
%portion of a citation is obvious, omit it, e.g.,
%Nebel~\shortcite{nebel:jair-2000}.  Collapse multiple citations as
%follows:~\cite{gls:hypertrees,levesque:functional-foundations}.
%\nocite{abelson-et-al:scheme}
%\nocite{bgf:Lixto}
%\nocite{brachman-schmolze:kl-one}
%\nocite{gottlob:nonmon}
%\nocite{gls:hypertrees}
%\nocite{levesque:functional-foundations}
%\nocite{levesque:belief}
%\nocite{nebel:jair-2000}
%
%\subsection{Footnotes}
%
%Place footnotes at the bottom of the page in a 9-point font.  Refer to
%them with superscript numbers.\footnote{This is how your footnotes
%should appear.} Separate them from the text by a short
%line.\footnote{Note the line separating these footnotes from the
%text.} Avoid footnotes as much as possible; they interrupt the flow of
%the text.
%
%\section{Illustrations}
%
%Place all illustrations (figures, drawings, tables, and photographs)
%throughout the paper at the places where they are first discussed,
%rather than at the end of the paper. If placed at the bottom or top of
%a page, illustrations may run across both columns.
%
%Illustrations must be rendered electronically or scanned and placed
%directly in your document. All illustrations should be in black and
%white, as color illustrations may cause problems. Line weights should
%be 1/2-point or thicker. Avoid screens and superimposing type on
%patterns as these effects may not reproduce well.
%
%Number illustrations sequentially. Use references of the following
%form: Figure 1, Table 2, etc. Place illustration numbers and captions
%under illustrations. Leave a margin of 1/4-inch around the area
%covered by the illustration and caption.  Use 9-point type for
%captions, labels, and other text in illustrations.
%
%\section*{Acknowledgments}
%
%The preparation of these instructions and the \LaTeX{} and Bib\TeX{}
%files that implement them was supported by Schlumberger Palo Alto
%Research, AT\&T Bell Laboratories, and Morgan Kaufmann Publishers.
%Preparation of the Microsoft Word file was supported by IJCAI.  An
%early version of this document was created by Shirley Jowell and Peter
%F. Patel-Schneider.  It was subsequently modified by Jennifer
%Ballentine and Thomas Dean, Bernhard Nebel, and Daniel Pagenstecher.
%These instructions are the same as the ones for IJCAI--05, prepared by
%Kurt Steinkraus, Massachusetts Institute of Technology, Computer
%Science and Artificial Intelligence Lab.
%
%\appendix
%
%\section{\LaTeX{} and Word Style Files}\label{stylefiles}
%
%The \LaTeX{} and Word style files are available on the IJCAI--11
%website, {\tt http://www.ijcai-11.org/}.
%These style files implement the formatting instructions in this
%document.
%
%The \LaTeX{} files are {\tt ijcai11.sty} and {\tt ijcai11.tex}, and
%the Bib\TeX{} files are {\tt named.bst} and {\tt ijcai11.bib}. The
%\LaTeX{} style file is for version 2e of \LaTeX{}, and the Bib\TeX{}
%style file is for version 0.99c of Bib\TeX{} ({\em not} version
%0.98i). The {\tt ijcai11.sty} file is the same as the {\tt
%ijcai07.sty} file used for IJCAI--07.
%
%The Microsoft Word style file consists of a single file, {\tt
%ijcai11.doc}. This template is the same as the one used for
%IJCAI--07.
%
%These Microsoft Word and \LaTeX{} files contain the source of the
%present document and may serve as a formatting sample.  
%
%Further information on using these styles for the preparation of
%papers for IJCAI--11 can be obtained by contacting {\tt
%pcchair11@ijcai.org}.

%% The file named.bst is a bibliography style file for BibTeX 0.99c
\bibliographystyle{named}
\bibliography{../bib}

\end{document}

